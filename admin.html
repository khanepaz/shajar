<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ” Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¬Ø±Ù‡â€ŒÙ†Ø§Ù…Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
        font-family: 'Vazirmatn', sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --info-color: #8e44ad;
      --bg-light: #f8f9fa;
      --bg-dark: #1a1a1a;
      --text-light: #2c3e50;
      --text-dark: #ffffff;
      --card-light: #ffffff;
      --card-dark: #2d2d2d;
      --border-light: #e1e8ed;
      --border-dark: #404040;
      --shadow-light: rgba(0,0,0,0.1);
      --shadow-dark: rgba(255,255,255,0.1);
    }
    [data-theme="dark"] {
      --bg-color: var(--bg-dark);
      --text-color: var(--text-dark);
      --card-color: var(--card-dark);
      --border-color: var(--border-dark);
      --shadow-color: var(--shadow-dark);
    }
    [data-theme="light"] {
      --bg-color: var(--bg-light);
      --text-color: var(--text-light);
      --card-color: var(--card-light);
      --border-color: var(--border-light);
      --shadow-color: var(--shadow-light);
    }
    body {
      background: linear-gradient(135deg, var(--bg-color), #f1f3f4);
      color: var(--text-color);
      font-family: 'Vazirmatn', 'Segoe UI', Tahoma, sans-serif;
      min-height: 100vh;
      transition: all 0.3s ease;
    }
    /* Header */
    .header {
      background: var(--card-color);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 20px var(--shadow-color);
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    .header h1 {
      font-size: 1.8em;
      font-weight: bold;
      color: var(--primary-color);
    }
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    /* Cards */
    .card {
      background: var(--card-color);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 8px 32px var(--shadow-color);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 48px var(--shadow-color);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }
    .card-title {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    /* Forms */
    .form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(300px, 100%), 1fr));
  gap: 20px;
  margin-bottom: 20px;
}
/* File Upload Styling - Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ */
.file-input-wrapper {
  position: relative;
  display: inline-block;
  width: 100%;
  overflow: hidden; /* Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² overflow */
}
.file-input {
  position: absolute;
  top: 0;
  right: 0; /* ØªØºÛŒÛŒØ±: Ø§Ø² left Ø¨Ù‡ right Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ù‡ØªØ± Ø¨Ø§ dir="rtl" */
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
  z-index: 10;
}
.file-input-label {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  border: 2px dashed var(--border-color);
  border-radius: 10px;
  background: var(--card-color);
  color: var(--text-color);
  cursor: pointer;
  transition: all 0.3s ease;
  user-select: none; /* Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ù…ØªÙ† */
}
.file-input-label:hover {
  border-color: var(--secondary-color);
  background: rgba(52, 152, 219, 0.05);
}
.file-input-label.has-file {
  border-color: var(--success-color);
  background: rgba(39, 174, 96, 0.05);
  color: var(--success-color);
}
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
    }
    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      background: var(--card-color);
      color: var(--text-color);
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    .form-control:invalid {
      border-color: var(--danger-color);
    }
    textarea.form-control {
      resize: vertical;
      min-height: 80px;
    }
    /* Buttons */
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      background: var(--secondary-color);
      color: white;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    .btn:active {
      transform: translateY(0);
    }
    .btn-success { background: var(--success-color); }
    .btn-warning { background: var(--warning-color); }
    .btn-danger { background: var(--danger-color); }
    .btn-info { background: var(--info-color); }
    .btn-outline {
      background: transparent;
      border: 2px solid var(--border-color);
      color: var(--text-color);
    }
    .btn-outline:hover {
      background: var(--border-color);
    }
    .btn-sm {
      padding: 8px 12px;
      font-size: 12px;
    }
    .btn-lg {
      padding: 16px 24px;
      font-size: 16px;
    }
    /* Preview Card */
    .preview-card {
      background: var(--card-color);
      border: 2px dashed var(--border-color);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      min-height: 250px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .preview-card:hover {
      border-color: var(--secondary-color);
      background: linear-gradient(135deg, var(--card-color), rgba(52, 152, 219, 0.05));
    }
    .preview-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--border-color);
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }
    .preview-card:hover .preview-avatar {
      border-color: var(--secondary-color);
      transform: scale(1.1);
    }
    .preview-name {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--text-color);
    }
    .preview-info {
      color: var(--text-color);
      opacity: 0.7;
      font-size: 0.9em;
    }
    /* Login Section */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--secondary-color), var(--info-color));
    }
    .login-card {
      background: var(--card-color);
      border-radius: 20px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      animation: slideUp 0.6s ease-out;
    }
    .login-icon {
      font-size: 4em;
      color: var(--secondary-color);
      margin-bottom: 20px;
    }
    .login-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 30px;
      color: var(--text-color);
    }
    /* Status Bar */
    .status-bar {
      background: linear-gradient(135deg, var(--info-color), var(--secondary-color));
      color: white;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      text-align: center;
    }
    .status-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .status-number {
      font-size: 1.5em;
      font-weight: bold;
    }
    .status-label {
      font-size: 0.9em;
      opacity: 0.9;
      margin-top: 5px;
    }
    /* Tables */
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-color);
    }
    .table th,
    .table td {
      padding: 12px 15px;
      text-align: right;
      border-bottom: 1px solid var(--border-color);
    }
    .table th {
      background: var(--border-color);
      font-weight: 600;
      color: var(--text-color);
    }
    .table tr:hover {
      background: rgba(52, 152, 219, 0.05);
    }
    /* Alert Messages */
/* Alert Messages - Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù‡Ù…Ù¾ÙˆØ´Ø§Ù†ÛŒ */
.alert {
  padding: 15px 20px;
  border-radius: 10px;
  margin: 0; /* Ø­Ø°Ù margin Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ù†Ø§Ø®ÙˆØ§Ø³ØªÙ‡ */
  border: 1px solid;
  display: flex;
  align-items: center;
  gap: 10px;
  /* ========== Ø§Ø¶Ø§ÙØ§Øª Ø¬Ø¯ÛŒØ¯ ========== */
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10000; /* Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ù‡Ù…ÛŒØ´Ù‡ Ø¯Ø± Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ù„Ø§ÛŒÙ‡ Ø§Ø³Øª */
  max-width: 500px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  animation: slideDown 0.3s ease-out; /* Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ Ø¸Ø§Ù‡Ø± Ø´Ø¯Ù† Ù†Ø±Ù… */
}
/* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¸Ø§Ù‡Ø± Ø´Ø¯Ù† Ù‡Ø´Ø¯Ø§Ø± */
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translate(-50%, -30px);
  }
  to {
    opacity: 1;
    transform: translate(-50%, 0);
  }
}
    .alert-success {
      background: rgba(39, 174, 96, 0.1);
      border-color: var(--success-color);
      color: var(--success-color);
    }
    .alert-warning {
      background: rgba(243, 156, 18, 0.1);
      border-color: var(--warning-color);
      color: var(--warning-color);
    }
    .alert-danger {
      background: rgba(231, 76, 60, 0.1);
      border-color: var(--danger-color);
      color: var(--danger-color);
    }
    .alert-info {
      background: rgba(52, 152, 219, 0.1);
      border-color: var(--secondary-color);
      color: var(--secondary-color);
    }
    /* Loading States */
    .loading {
      opacity: 0.6;
      pointer-events: none;
      position: relative;
    }
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-top-color: var(--secondary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      transform: translate(-50%, -50%);
    }
    /* Animations */
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .fade-in {
      animation: slideUp 0.6s ease-out;
    }
    /* Theme Toggle */
    .theme-toggle {
      background: var(--card-color);
      color: var(--text-color);
      border: 2px solid var(--border-color);
    }
    /* Responsive Design */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 0 15px;
      }
      .card {
        padding: 20px;
      }
      .status-bar {
        grid-template-columns: repeat(2, 1fr);
      }
      .btn {
        padding: 10px 16px;
        font-size: 13px;
      }
    }
    @media (max-width: 480px) {
      .login-card {
        margin: 20px;
        padding: 30px 25px;
      }
      .status-bar {
        grid-template-columns: 1fr;
      }
      .header-actions {
        width: 100%;
        justify-content: center;
      }
    }
    /* File Upload Styling */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .file-input {
      position: absolute;
      left: -9999px;
    }
    .file-input-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border: 2px dashed var(--border-color);
      border-radius: 10px;
      background: var(--card-color);
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .file-input-label:hover {
      border-color: var(--secondary-color);
      background: rgba(52, 152, 219, 0.05);
    }
    .file-input-label.has-file {
      border-color: var(--success-color);
      background: rgba(39, 174, 96, 0.05);
      color: var(--success-color);
    }
    /* ========== NEW STYLES ========== */
    .spouse-section {
      background: rgba(52, 152, 219, 0.05);
      border: 2px dashed var(--secondary-color);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    .spouse-section.active {
      display: block;
    }
    .spouse-section .card-title {
      color: var(--secondary-color);
      margin-bottom: 15px;
    }
    .generation-header {
      background: var(--info-color);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      margin: 20px 0 10px 0;
      font-weight: bold;
      text-align: center;
    }
    /* ========== EVENT MODAL STYLES ========== */
    #eventModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    /* Ensure alerts are on top */
    .alert {
      z-index: 10000; /* Make sure it's above everything else */
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 500px;
    }
  </style>
</head>
<body data-theme="light">
  <!-- Login Section -->
  <div id="loginSection" class="login-container">
    <div class="login-card">
      <div class="login-icon">
        <i class="fas fa-lock"></i>
      </div>
      <h2 class="login-title">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
      <div class="form-group">
        <input type="password" id="passwordInput" class="form-control" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" onkeypress="handleEnterKey(event)">
      </div>
      <button class="btn btn-lg" onclick="checkPassword()" style="width: 100%;">
        <i class="fas fa-sign-in-alt"></i> ÙˆØ±ÙˆØ¯
      </button>
      <div id="loginError" style="display: none; margin-top: 15px;" class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!</span>
      </div>
    </div>
  </div>
  <!-- Admin Panel -->
  <div id="adminPanel" style="display: none;">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1><i class="fas fa-cogs"></i> Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¬Ø±Ù‡â€ŒÙ†Ø§Ù…Ù‡</h1>
        <div class="header-actions">
          <button class="btn theme-toggle" onclick="toggleTheme()">
            <i class="fas fa-moon"></i>
          </button>
          <button class="btn btn-outline" onclick="backupData()">
            <i class="fas fa-download"></i> Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ
          </button>
          <button class="btn btn-info" onclick="importData()">
            <i class="fas fa-upload"></i> Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ
          </button>
          <a href="index.html" class="btn btn-success">
            <i class="fas fa-eye"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø´Ø¬Ø±Ù‡â€ŒÙ†Ø§Ù…Ù‡
          </a>
        </div>
      </div>
    </div>
    <div class="container">
      <!-- Status Bar -->
      <div class="status-bar" id="statusBar">
        <div class="status-item">
          <span class="status-number" id="totalMembers">0</span>
          <span class="status-label">Ú©Ù„ Ø§Ø¹Ø¶Ø§</span>
        </div>
        <div class="status-item">
          <span class="status-number" id="totalMales">0</span>
          <span class="status-label">Ù…Ø±Ø¯Ø§Ù†</span>
        </div>
        <div class="status-item">
          <span class="status-number" id="totalFemales">0</span>
          <span class="status-label">Ø²Ù†Ø§Ù†</span>
        </div>
        <div class="status-item">
          <span class="status-number" id="lastUpdate">---</span>
          <span class="status-label">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</span>
        </div>
      </div>
      <!-- Add New Person -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-user-plus"></i>
            <span id="formTitle">Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯</span>
          </div>
          <button class="btn btn-sm btn-outline" onclick="resetForm()">
            <i class="fas fa-redo"></i> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
          </button>
        </div>
        <form id="personForm" onsubmit="handleSubmit(event)">
          <div class="form-grid">
            <div>
              <div class="form-group">
                <label class="form-label">Ù†Ø§Ù… Ú©Ø§Ù…Ù„ *</label>
                <input type="text" id="nameInput" class="form-control" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" required>
              </div>
              <div class="form-group">
                <label class="form-label">Ø³Ø§Ù„ ØªÙˆÙ„Ø¯</label>
                <input type="text" id="birthInput" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Û±Û³Û¶Û°">
              </div>
              <div class="form-group">
                <label class="form-label">Ø¬Ù†Ø³ÛŒØª</label>
                <select id="genderInput" class="form-control">
                  <option value="male">Ù…Ø±Ø¯ (â™‚)</option>
                  <option value="female">Ø²Ù† (â™€)</option>
                  <option value="unknown">Ù†Ø§Ù…Ø´Ø®Øµ (?)</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                <textarea id="descInput" class="form-control" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø§ÛŒÙ† ÙØ±Ø¯..." rows="3"></textarea>
              </div>
              <!-- ========== NEW FIELD ========== -->
              <div class="form-group">
                <label class="form-label">
                  <input type="checkbox" id="hasSpouseCheckbox">
                  Ù‡Ù…Ø³Ø± Ø¯Ø§Ø±Ø¯
                </label>
              </div>
            </div>
            <div>
              <div class="form-group">
                <label class="form-label">ÙˆØ§Ù„Ø¯</label>
                <select id="parentInput" class="form-control" disabled>
                  <option value="">Ø±ÛŒØ´Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">ØªØµÙˆÛŒØ±</label>
                <div class="file-input-wrapper">
                  <input type="file" id="photoInput" class="file-input" accept="image/*">
                  <label for="photoInput" class="file-input-label">
                    <i class="fas fa-camera"></i>
                    <span id="fileLabel">Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ±</span>
                  </label>
                </div>
              </div>
              <div class="preview-card">
                <img id="previewImage" class="preview-avatar" src="https://ui-avatars.com/api/?name=Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´&background=random&size=150" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´">
                <div class="preview-name" id="previewName">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ±Ø¯</div>
                <div class="preview-info" id="previewInfo">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
              </div>
            </div>
          </div>
          <!-- ========== SPOUSE SECTION ========== -->
          <div id="spouseSection" class="spouse-section">
            <div class="card-title">
              <i class="fas fa-heart"></i>
              Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ù…Ø³Ø±
            </div>
            <div class="form-grid">
              <div>
                <div class="form-group">
                  <label class="form-label">Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ù‡Ù…Ø³Ø± *</label>
                  <input type="text" id="spouseNameInput" class="form-control" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ù‡Ù…Ø³Ø±" >
                </div>
                <div class="form-group">
                  <label class="form-label">Ø³Ø§Ù„ ØªÙˆÙ„Ø¯ Ù‡Ù…Ø³Ø±</label>
                  <input type="text" id="spouseBirthInput" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Û±Û³Û¶Û°">
                </div>
                <div class="form-group">
                  <label class="form-label">Ø¬Ù†Ø³ÛŒØª Ù‡Ù…Ø³Ø±</label>
                  <select id="spouseGenderInput" class="form-control">
                    <option value="male">Ù…Ø±Ø¯ (â™‚)</option>
                    <option value="female">Ø²Ù† (â™€)</option>
                    <option value="unknown">Ù†Ø§Ù…Ø´Ø®Øµ (?)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª Ù‡Ù…Ø³Ø±</label>
                  <textarea id="spouseDescInput" class="form-control" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù‡Ù…Ø³Ø±..." rows="3"></textarea>
                </div>
              </div>
              <div>
                <div class="form-group">
                  <label class="form-label">ØªØµÙˆÛŒØ± Ù‡Ù…Ø³Ø±</label>
                  <div class="file-input-wrapper">
                    <input type="file" id="spousePhotoInput" class="file-input" accept="image/*">
                    <label for="spousePhotoInput" class="file-input-label">
                      <i class="fas fa-camera"></i>
                      <span id="spouseFileLabel">Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ± Ù‡Ù…Ø³Ø±</span>
                    </label>
                  </div>
                </div>
                <div class="preview-card">
                  <img id="spousePreviewImage" class="preview-avatar" src="https://ui-avatars.com/api/?name=Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´&background=random&size=150" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù‡Ù…Ø³Ø±">
                  <div class="preview-name" id="spousePreviewName">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù‡Ù…Ø³Ø±</div>
                  <div class="preview-info" id="spousePreviewInfo">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
                </div>
              </div>
            </div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button type="submit" class="btn btn-success btn-lg" id="submitButton">
              <i class="fas fa-plus"></i>
              <span id="submitText">Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯</span>
            </button>
            <button type="button" class="btn btn-warning btn-lg" onclick="cancelEdit()" id="cancelButton" style="display: none; margin-right: 10px;">
              <i class="fas fa-times"></i> Ù„ØºÙˆ ÙˆÛŒØ±Ø§ÛŒØ´
            </button>
          </div>
        </form>
      </div>
      <!-- Manage Members -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-users-cog"></i>
            Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¹Ø¶Ø§
          </div>
        </div>
        <div class="form-grid">
          <div>
            <div class="form-group">
              <label class="form-label">Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ±Ø¯</label>
              <input type="text" id="searchMember" class="form-control" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…...">
            </div>
            <div class="form-group">
              <select id="memberSelect" class="form-control" size="5">
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ±Ø¯ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§ Ø­Ø°Ù</option>
              </select>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 15px;">
            <button class="btn btn-warning" onclick="editMember()">
              <i class="fas fa-edit"></i> ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
            </button>
            <button class="btn btn-danger" onclick="deleteMember()">
              <i class="fas fa-trash"></i> Ø­Ø°Ù ÙØ±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
            </button>
            <hr>
            <button class="btn btn-info" onclick="viewMemberDetails()">
              <i class="fas fa-info-circle"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
            </button>
            <button class="btn btn-outline" onclick="refreshData()">
              <i class="fas fa-sync"></i> Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            </button>
          </div>
        </div>
      </div>
      <!-- Add Event -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-calendar-plus"></i>
            Ø§ÙØ²ÙˆØ¯Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯
          </div>
        </div>
        <form id="eventForm" onsubmit="handleEventSubmit(event)">
          <div class="form-grid">
            <div>
              <div class="form-group">
                <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ±Ø¯ *</label>
                <select id="eventPersonSelect" class="form-control" required>
                  <option value="">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Ù†ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯ *</label>
                <select id="eventTypeSelect" class="form-control" required>
                  <option value="birth">ğŸ‘¶ ØªÙˆÙ„Ø¯</option>
                  <option value="wedding">ğŸ’ Ø§Ø²Ø¯ÙˆØ§Ø¬</option>
                  <option value="death">âš°ï¸ ÙÙˆØª</option>
                  <option value="graduation">ğŸ“ ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ÛŒ</option>
                  <option value="work">ğŸ’¼ Ø´ØºÙ„</option>
                  <option value="travel">âœˆï¸ Ø³ÙØ±</option>
                  <option value="other">ğŸ“ Ø³Ø§ÛŒØ±</option>
                </select>
              </div>
            </div>
            <div>
              <div class="form-group">
                <label class="form-label">Ø³Ø§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯</label>
                <input type="text" id="eventYearInput" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Û±Û´Û°Û°">
              </div>
              <div class="form-group">
                <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ *</label>
                <textarea id="eventDescInput" class="form-control" placeholder="ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ù…Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯..." rows="2" required></textarea>
              </div>
            </div>
          </div>
          <div style="text-align: center;">
            <button type="submit" class="btn btn-success">
              <i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯
            </button>
          </div>
        </form>
      </div>
      <!-- Family Members Table -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-table"></i>
            ÙÙ‡Ø±Ø³Øª Ø§Ø¹Ø¶Ø§ÛŒ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡
          </div>
          <div>
            <button class="btn btn-sm btn-outline" onclick="exportToCSV()">
              <i class="fas fa-file-csv"></i> Ø®Ø±ÙˆØ¬ÛŒ CSV
            </button>
          </div>
        </div>
        <div class="table-container">
          <table class="table" id="membersTable">
            <thead>
              <tr>
                <th>Ø´Ù†Ø§Ø³Ù‡</th>
                <th>Ù†Ø§Ù… Ùˆ Ù‡Ù…Ø³Ø±</th>
                <th>Ø³Ø§Ù„ ØªÙˆÙ„Ø¯</th>
                <th>Ø¬Ù†Ø³ÛŒØª</th>
                <th>ÙˆØ§Ù„Ø¯</th>
                <th>ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody id="membersTableBody">
              <!-- Table content will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
      <!-- Advanced Settings -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-cog"></i>
            ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡
          </div>
        </div>
        <div class="form-grid">
          <div>
            <h5 style="margin-bottom: 15px; color: var(--primary-color);">
              <i class="fas fa-database"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            </h5>
            <button class="btn btn-info" onclick="validateData()" style="width: 100%; margin-bottom: 10px;">
              <i class="fas fa-check-circle"></i> Ø¨Ø±Ø±Ø³ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            </button>
            <button class="btn btn-warning" onclick="repairData()" style="width: 100%; margin-bottom: 10px;">
              <i class="fas fa-wrench"></i> ØªØ¹Ù…ÛŒØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            </button>
            <button class="btn btn-danger" onclick="resetAllData()" style="width: 100%;">
              <i class="fas fa-bomb"></i> Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…
            </button>
          </div>
          <div>
            <h5 style="margin-bottom: 15px; color: var(--primary-color);">
              <i class="fas fa-chart-line"></i> Ø¢Ù…Ø§Ø± Ùˆ Ú¯Ø²Ø§Ø±Ø´Ø§Øª
            </h5>
            <button class="btn btn-info" onclick="generateReport()" style="width: 100%; margin-bottom: 10px;">
              <i class="fas fa-chart-bar"></i> ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„
            </button>
            <button class="btn btn-outline" onclick="showStatistics()" style="width: 100%; margin-bottom: 10px;">
              <i class="fas fa-analytics"></i> Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ
            </button>
            <button class="btn btn-success" onclick="exportAdvanced()" style="width: 100%;">
              <i class="fas fa-file-export"></i> Ø®Ø±ÙˆØ¬ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ========== EVENT MODAL ========== -->
  <!-- Event Management Modal -->
  <div id="eventModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div class="card" style="width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; animation: slideUp 0.3s ease-out;">
      <div class="card-header">
        <div class="card-title">
          <i class="fas fa-list"></i>
          <span id="modalTitle">Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</span>
        </div>
        <button class="btn btn-sm btn-outline" onclick="closeEventModal()">
          <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
        </button>
      </div>
      <div id="eventListContainer" style="padding: 20px;">
        <!-- Event list will be populated here -->
      </div>
      <div style="padding: 20px; border-top: 1px solid var(--border-color);">
        <button class="btn btn-success" onclick="addNewEventInModal()">
          <i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯
        </button>
      </div>
    </div>
  </div>
  <!-- Hidden file input for import -->
  <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
<script>
// ===============================
// Configuration & Global Variables  
// ===============================
const ADMIN_PASSWORD = "admin123"; // Change this to your desired password
let familyData = [];
let isEditMode = false;
let editingId = null;
let currentTheme = localStorage.getItem('theme') || 'light';
// ===============================
// Initialization
// ===============================
document.addEventListener('DOMContentLoaded', function() {
  // Apply saved theme
  document.body.setAttribute('data-theme', currentTheme);
  updateThemeIcon();
  // Setup event listeners
  setupEventListeners();
});
function setupEventListeners() {
  // Preview updates for spouse
document.getElementById('spouseNameInput').addEventListener('input', updateSpousePreview);
document.getElementById('spouseGenderInput').addEventListener('change', updateSpousePreview); // <-- Ø§ÛŒÙ† Ø®Ø· Ø¬Ø¯ÛŒØ¯ Ø§Ø³Øª
document.getElementById('spouseBirthInput').addEventListener('input', updateSpousePreview);
document.getElementById('spouseDescInput').addEventListener('input', updateSpousePreview);
    // Preview updates for main person
  document.getElementById('nameInput').addEventListener('input', updatePreview);
  document.getElementById('genderInput').addEventListener('change', updatePreview);
  document.getElementById('birthInput').addEventListener('input', updatePreview);
  document.getElementById('descInput').addEventListener('input', updatePreview);
  // Photo upload for main person
  document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
  // Photo upload for spouse
  document.getElementById('spousePhotoInput').addEventListener('change', handleSpousePhotoUpload);
  // Toggle spouse section
  document.getElementById('hasSpouseCheckbox').addEventListener('change', toggleSpouseSection);
  // Search functionality
  document.getElementById('searchMember').addEventListener('input', handleMemberSearch);
  // Member selection
  document.getElementById('memberSelect').addEventListener('change', function() {
    const selectedId = this.value;
    if (selectedId) {
      const member = familyData.find(m => m.id == selectedId);
      if (member) {
        showMemberInfo(member);
      }
    }
  });
}
// ===============================
// Authentication
// ===============================
function checkPassword() {
  const password = document.getElementById('passwordInput').value;
  const loginError = document.getElementById('loginError');
  if (password === ADMIN_PASSWORD) {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    document.getElementById('adminPanel').classList.add('fade-in');
    // Initialize admin panel
    loadFamilyData();
    refreshAllSelectors();
    updateStats();
    renderMembersTable();
  } else {
    loginError.style.display = 'block';
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordInput').focus();
  }
}
function handleEnterKey(event) {
  if (event.key === 'Enter') {
    checkPassword();
  }
}
// ===============================
// Data Management
// ===============================
function loadFamilyData() {
  const stored = localStorage.getItem('familyData');
  if (stored) {
    try {
      familyData = JSON.parse(stored);
    } catch (e) {
      console.error('Error parsing stored ', e);
      familyData = [];
      showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', 'danger');
    }
  } else {
    familyData = [];
  }
}
function saveFamilyData() {
  try {
    localStorage.setItem('familyData', JSON.stringify(familyData));
    localStorage.setItem('familyDataTimestamp', Date.now().toString());
    updateStats();
    showAlert('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯', 'success');
  } catch (e) {
    console.error('Error saving ', e);
    showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', 'danger');
  }
}
function refreshData() {
  loadFamilyData();
  refreshAllSelectors();
  updateStats();
  renderMembersTable();
  showAlert('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯', 'success');
}
// ===============================
// Form Handling
// ===============================
function handleSubmit(event) {
  event.preventDefault();
  const name = document.getElementById('nameInput').value.trim();
  if (!name) {
    showAlert('Ù†Ø§Ù… ÙØ±Ø¯ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³Øª', 'danger');
    return;
  }
  // Validate if it's the first person (root)
  if (familyData.length === 0) {
    if (document.getElementById('parentInput').value !== "") {
      showAlert('Ø§ÙˆÙ„ÛŒÙ† ÙØ±Ø¯ Ø¨Ø§ÛŒØ¯ Ø±ÛŒØ´Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ Ø¨Ø§Ø´Ø¯!', 'danger');
      return;
    }
  }
  // If has spouse, validate spouse fields
  const hasSpouse = document.getElementById('hasSpouseCheckbox').checked;
  if (hasSpouse) {
    const spouseName = document.getElementById('spouseNameInput').value.trim();
    if (!spouseName) {
      showAlert('Ù†Ø§Ù… Ù‡Ù…Ø³Ø± Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³Øª', 'danger');
      return;
    }
  }
  if (isEditMode) {
    updatePerson();
  } else {
    addPerson();
  }
}
function addPerson() {
  const newId = Math.max(...familyData.map(p => p.id || 0), 0) + 1;
  const hasSpouse = document.getElementById('hasSpouseCheckbox').checked;
  // Create main person object
  const person = {
    id: newId,
    name: document.getElementById('nameInput').value.trim(),
    birth: document.getElementById('birthInput').value.trim(),
    gender: document.getElementById('genderInput').value,
    desc: document.getElementById('descInput').value.trim(),
    parentId: familyData.length > 0 ? parseInt(document.getElementById('parentInput').value) : null, // Only set parent if not root
    photo: document.getElementById('previewImage').src,
    events: [],
    spouseId: null // Will be set after spouse is created
  };
  // If has spouse, create spouse object
  if (hasSpouse) {
    const spouseId = newId + 1; // Assign next ID to spouse
    const spouse = {
      id: spouseId,
      name: document.getElementById('spouseNameInput').value.trim(),
      birth: document.getElementById('spouseBirthInput').value.trim(),
      gender: document.getElementById('spouseGenderInput').value,
      desc: document.getElementById('spouseDescInput').value.trim(),
      parentId: null, // Spouse doesn't have a separate parent in this context
      photo: document.getElementById('spousePreviewImage').src,
      events: [],
      spouseId: newId // Point back to main person
    };
    // Set spouseId for main person
    person.spouseId = spouseId;
    // Add both to familyData
    familyData.push(person);
    familyData.push(spouse);
  } else {
    // Add only main person
    familyData.push(person);
  }
  saveFamilyData();
  resetForm();
  refreshAllSelectors();
  renderMembersTable();
  showAlert(`${person.name} ${hasSpouse ? 'Ùˆ Ù‡Ù…Ø³Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù†Ø¯' : 'Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯'}`, 'success');
}
// ========== ØªØ§Ø¨Ø¹ updatePerson Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ ==========
// ========== ØªØ§Ø¨Ø¹ updatePerson Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ ==========
function updatePerson() {
  const index = familyData.findIndex(p => p.id === editingId);
  if (index === -1) {
    showAlert('ÙØ±Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'danger');
    return;
  }
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ø¯ Ø§ØµÙ„ÛŒ
  const person = familyData[index];
  person.name = document.getElementById('nameInput').value.trim();
  person.birth = document.getElementById('birthInput').value.trim();
  person.gender = document.getElementById('genderInput').value;
  person.desc = document.getElementById('descInput').value.trim();
  person.parentId = familyData.length > 1 ? parseInt(document.getElementById('parentInput').value) : null;
  person.photo = document.getElementById('previewImage').src;
  // Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ù…Ø³Ø±
  const hasSpouse = document.getElementById('hasSpouseCheckbox').checked;
  if (hasSpouse) {
    const spouseName = document.getElementById('spouseNameInput').value.trim();
    if (!spouseName) {
      showAlert('Ù†Ø§Ù… Ù‡Ù…Ø³Ø± Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³Øª', 'danger');
      return;
    }
    // Ø§Ú¯Ø± ÙØ±Ø¯ Ù‚Ø¨Ù„Ø§Ù‹ Ù‡Ù…Ø³Ø± Ù†Ø¯Ø§Ø´ØªÙ‡ØŒ Ù‡Ù…Ø³Ø± Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
    if (!person.spouseId) {
      const newSpouseId = Math.max(...familyData.map(p => p.id || 0), 0) + 1;
      const newSpouse = {
        id: newSpouseId,
        name: spouseName,
        birth: document.getElementById('spouseBirthInput').value.trim(),
        gender: document.getElementById('spouseGenderInput').value,
        desc: document.getElementById('spouseDescInput').value.trim(),
        parentId: null,
        photo: document.getElementById('spousePreviewImage').src,
        events: [],
        spouseId: editingId // Ù‡Ù…Ø³Ø± Ø¨Ù‡ ÙØ±Ø¯ Ø§ØµÙ„ÛŒ Ø§Ø´Ø§Ø±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
      };
      person.spouseId = newSpouseId; // ÙØ±Ø¯ Ø§ØµÙ„ÛŒ Ø¨Ù‡ Ù‡Ù…Ø³Ø± Ø§Ø´Ø§Ø±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
      familyData.push(newSpouse);
    } else {
      // Ø§Ú¯Ø± Ù‡Ù…Ø³Ø± Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§ØªØ´ Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù†
      const spouseIndex = familyData.findIndex(p => p.id === person.spouseId);
      if (spouseIndex !== -1) {
        const spouse = familyData[spouseIndex];
        spouse.name = spouseName;
        spouse.birth = document.getElementById('spouseBirthInput').value.trim();
        spouse.gender = document.getElementById('spouseGenderInput').value;
        spouse.desc = document.getElementById('spouseDescInput').value.trim();
        spouse.photo = document.getElementById('spousePreviewImage').src;
        // spouseId Ù‡Ù…Ø³Ø± Ù‚Ø¨Ù„Ø§Ù‹ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ùˆ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ ØªØºÛŒÛŒØ± Ù†ÛŒØ³Øª
      }
    }
  } else {
    // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ú¯Ø²ÛŒÙ†Ù‡ "Ù‡Ù…Ø³Ø± Ø¯Ø§Ø±Ø¯" Ø±Ø§ Ø¨Ø±Ø¯Ø§Ø´ØªÙ‡ØŒ Ù‡Ù…Ø³Ø± Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ø­Ø°Ù Ú©Ù†
    if (person.spouseId) {
      familyData = familyData.filter(p => p.id !== person.spouseId);
      person.spouseId = null;
    }
  }
  saveFamilyData();
  // ========== Ø®Ø· Ù…Ù‡Ù…: ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ cancelEdit Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ ==========
  cancelEdit();
  showAlert(`Ø§Ø·Ù„Ø§Ø¹Ø§Øª ${person.name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯`, 'success');
}
// ========== ØªØ§Ø¨Ø¹ cancelEdit Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ ==========
function cancelEdit() {
  isEditMode = false;
  editingId = null;
  // ========== Ø§ØµÙ„Ø§Ø­: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù†Øª Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ± Ø¢Ù† ==========
  const formTitleEl = document.getElementById('formTitle');
  const submitTextEl = document.getElementById('submitText');
  const submitButtonEl = document.getElementById('submitButton');
  const cancelButtonEl = document.getElementById('cancelButton');
  if (formTitleEl) formTitleEl.textContent = 'Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯';
  if (submitTextEl) submitTextEl.textContent = 'Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯';
  if (submitButtonEl) submitButtonEl.innerHTML = '<i class="fas fa-plus"></i> <span>Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯</span>';
  if (cancelButtonEl) cancelButtonEl.style.display = 'none';
  // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ ÙØ±Ù… Ùˆ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´â€ŒÙ‡Ø§
  resetForm();
  // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ùˆ Ø¬Ø¯ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²
  refreshAllSelectors();
  renderMembersTable();
}
function resetForm() {
  document.getElementById('personForm').reset();
  // Reset main person preview
  document.getElementById('previewImage').src = 'https://ui-avatars.com/api/?name=Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´&background=random&size=150';
  document.getElementById('previewName').textContent = 'Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ±Ø¯';
  document.getElementById('previewInfo').textContent = 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯';
  document.getElementById('fileLabel').textContent = 'Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ±';
  document.getElementById('photoInput').value = '';
  document.querySelector('.file-input-label').classList.remove('has-file');
  // Reset spouse preview
  document.getElementById('spousePreviewImage').src = 'https://ui-avatars.com/api/?name=Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´&background=random&size=150';
  document.getElementById('spousePreviewName').textContent = 'Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù‡Ù…Ø³Ø±';
  document.getElementById('spousePreviewInfo').textContent = 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯';
  document.getElementById('spouseFileLabel').textContent = 'Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ± Ù‡Ù…Ø³Ø±';
  document.getElementById('spousePhotoInput').value = '';
  document.querySelector('[for="spousePhotoInput"]').classList.remove('has-file');
  // Reset spouse section
  document.getElementById('spouseSection').classList.remove('active');
  document.getElementById('hasSpouseCheckbox').checked = false;
  // If no family members exist, disable parent selector
  if (familyData.length === 0) {
    document.getElementById('parentInput').disabled = true;
  }
}
// ===============================
// Preview Functions
// ===============================
function updatePreview() {
  const name = document.getElementById('nameInput').value.trim() || 'Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ±Ø¯';
  const birth = document.getElementById('birthInput').value.trim();
  const gender = document.getElementById('genderInput').value;
  const desc = document.getElementById('descInput').value.trim();
  document.getElementById('previewName').textContent = name;
  const genderText = gender === 'male' ? 'Ù…Ø±Ø¯ (â™‚)' : gender === 'female' ? 'Ø²Ù† (â™€)' : 'Ù†Ø§Ù…Ø´Ø®Øµ (?)';
  const birthText = birth ? `Ù…ØªÙˆÙ„Ø¯ ${birth}` : '';
  const descText = desc ? ` â€¢ ${desc}` : '';
  document.getElementById('previewInfo').textContent = `${genderText}${birthText ? ' â€¢ ' + birthText : ''}${descText}`;
  // Update preview image if no custom image is selected
  if (!document.getElementById('photoInput').files[0]) {
    document.getElementById('previewImage').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&size=150`;
  }
}
function handlePhotoUpload(event) {
  const file = event.target.files[0];
  const fileLabel = document.getElementById('fileLabel');
  const fileLabelElement = document.querySelector('.file-input-label');
  if (file) {
    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      showAlert('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯', 'danger');
      event.target.value = '';
      return;
    }
    // Validate file type
    if (!file.type.startsWith('image/')) {
      showAlert('ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØµÙˆÛŒØ±ÛŒ Ù…Ø¬Ø§Ø² Ù‡Ø³ØªÙ†Ø¯', 'danger');
      event.target.value = '';
      return;
    }
    // ========== Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ==========
    fileLabel.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...';
    fileLabelElement.style.opacity = '0.7';
    fileLabelElement.style.pointerEvents = 'none'; // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ù„ÛŒÚ© Ù…Ø¬Ø¯Ø¯
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('previewImage').src = e.target.result;
      fileLabel.textContent = file.name;
      fileLabelElement.classList.add('has-file');
      // ========== Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ ==========
      fileLabelElement.style.opacity = '1';
      fileLabelElement.style.pointerEvents = 'auto';
    };
    reader.onerror = function() {
      showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„', 'danger');
      // ========== Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ ==========
      fileLabelElement.style.opacity = '1';
      fileLabelElement.style.pointerEvents = 'auto';
      fileLabel.textContent = 'Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ±';
      event.target.value = '';
    };
    reader.readAsDataURL(file);
  } else {
    fileLabel.textContent = 'Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ±';
    fileLabelElement.classList.remove('has-file');
    updatePreview(); // Reset to default avatar
  }
}
function handleSpousePhotoUpload(event) {
  const file = event.target.files[0];
  const fileLabel = document.getElementById('spouseFileLabel');
  const fileLabelElement = document.querySelector('[for="spousePhotoInput"]');
  if (file) {
    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      showAlert('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯', 'danger');
      event.target.value = '';
      return;
    }
    // Validate file type
    if (!file.type.startsWith('image/')) {
      showAlert('ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØµÙˆÛŒØ±ÛŒ Ù…Ø¬Ø§Ø² Ù‡Ø³ØªÙ†Ø¯', 'danger');
      event.target.value = '';
      return;
    }
    // ========== Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ==========
    fileLabel.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...';
    fileLabelElement.style.opacity = '0.7';
    fileLabelElement.style.pointerEvents = 'none';
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('spousePreviewImage').src = e.target.result;
      fileLabel.textContent = file.name;
      fileLabelElement.classList.add('has-file');
      // ========== Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ ==========
      fileLabelElement.style.opacity = '1';
      fileLabelElement.style.pointerEvents = 'auto';
    };
    reader.onerror = function() {
      showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„', 'danger');
      // ========== Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ ==========
      fileLabelElement.style.opacity = '1';
      fileLabelElement.style.pointerEvents = 'auto';
      fileLabel.textContent = 'Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ± Ù‡Ù…Ø³Ø±';
      event.target.value = '';
    };
    reader.readAsDataURL(file);
  } else {
    fileLabel.textContent = 'Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ± Ù‡Ù…Ø³Ø±';
    fileLabelElement.classList.remove('has-file');
    updateSpousePreview(); // Reset to default avatar
  }
}
function updateSpousePreview() {
  const name = document.getElementById('spouseNameInput').value.trim() || 'Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù‡Ù…Ø³Ø±';
  const birth = document.getElementById('spouseBirthInput').value.trim();
  const gender = document.getElementById('spouseGenderInput').value;
  const desc = document.getElementById('spouseDescInput').value.trim();
  document.getElementById('spousePreviewName').textContent = name;
  const genderText = gender === 'male' ? 'Ù…Ø±Ø¯ (â™‚)' : gender === 'female' ? 'Ø²Ù† (â™€)' : 'Ù†Ø§Ù…Ø´Ø®Øµ (?)';
  const birthText = birth ? `Ù…ØªÙˆÙ„Ø¯ ${birth}` : '';
  const descText = desc ? ` â€¢ ${desc}` : '';
  document.getElementById('spousePreviewInfo').textContent = `${genderText}${birthText ? ' â€¢ ' + birthText : ''}${descText}`;
  // Update preview image if no custom image is selected
  if (!document.getElementById('spousePhotoInput').files[0]) {
    document.getElementById('spousePreviewImage').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&size=150`;
  }
}
function toggleSpouseSection() {
  const spouseSection = document.getElementById('spouseSection');
  if (this.checked) {
    spouseSection.classList.add('active');
    // Initialize spouse preview
    updateSpousePreview();
  } else {
    spouseSection.classList.remove('active');
  }
}
// ===============================
// Member Management
// ===============================
function refreshAllSelectors() {
  const selectors = [
    'parentInput',
    'memberSelect',
    'eventPersonSelect'
  ];
  selectors.forEach(selectorId => {
    const selector = document.getElementById(selectorId);
    const currentValue = selector.value;
    // Clear options
    selector.innerHTML = '';
    // Add default option for parentInput
    if (selectorId === 'parentInput') {
      if (familyData.length === 0) {
        selector.innerHTML = '<option value="">Ø±ÛŒØ´Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡</option>';
        selector.disabled = true;
      } else {
        selector.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ§Ù„Ø¯ Ø§Ø² Ø±ÛŒØ´Ù‡</option>';
        selector.disabled = false;
      }
    } else if (selectorId === 'memberSelect') {
      selector.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ±Ø¯ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§ Ø­Ø°Ù</option>';
    } else {
      selector.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯</option>';
    }
    // Add family members
    familyData.forEach(person => {
      // Skip current person in spouse selector during edit (not applicable here)
      const option = document.createElement('option');
      option.value = person.id;
      option.textContent = `${person.name} (${person.birth || 'Ù†Ø§Ù…Ø´Ø®Øµ'})`;
      selector.appendChild(option);
    });
    // Restore previous value if still valid
    if (currentValue && Array.from(selector.options).some(opt => opt.value === currentValue)) {
      selector.value = currentValue;
    }
  });
}
function handleMemberSearch() {
  const searchTerm = document.getElementById('searchMember').value.toLowerCase();
  const memberSelect = document.getElementById('memberSelect');
  Array.from(memberSelect.options).forEach(option => {
    if (option.value === '') return; // Skip default option
    const shouldShow = option.textContent.toLowerCase().includes(searchTerm);
    option.style.display = shouldShow ? 'block' : 'none';
  });
}
function showMemberInfo(member) {
  document.getElementById('previewName').textContent = member.name;
  const genderText = member.gender === 'male' ? 'Ù…Ø±Ø¯ (â™‚)' : member.gender === 'female' ? 'Ø²Ù† (â™€)' : 'Ù†Ø§Ù…Ø´Ø®Øµ (?)';
  const birthText = member.birth ? `Ù…ØªÙˆÙ„Ø¯ ${member.birth}` : '';
  const descText = member.desc ? ` â€¢ ${member.desc}` : '';
  document.getElementById('previewInfo').textContent = `${genderText}${birthText ? ' â€¢ ' + birthText : ''}${descText}`;
  document.getElementById('previewImage').src = member.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=random&size=150`;
}
function editMember() {
  const selectedId = document.getElementById('memberSelect').value;
  if (!selectedId) {
    showAlert('Ù„Ø·ÙØ§Ù‹ ÙØ±Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'warning');
    return;
  }
  const member = familyData.find(m => m.id == selectedId);
  if (!member) {
    showAlert('ÙØ±Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'danger');
    return;
  }
  // Switch to edit mode
  isEditMode = true;
  editingId = member.id;
  // Update form title and buttons
  document.getElementById('formTitle').textContent = `ÙˆÛŒØ±Ø§ÛŒØ´ ${member.name}`;
  document.getElementById('submitText').textContent = 'Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª';
  document.getElementById('submitButton').innerHTML = '<i class="fas fa-save"></i> <span>Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</span>';
  document.getElementById('cancelButton').style.display = 'inline-flex';
  // Fill form with member data
  document.getElementById('nameInput').value = member.name;
  document.getElementById('birthInput').value = member.birth || '';
  document.getElementById('genderInput').value = member.gender || 'unknown';
  document.getElementById('descInput').value = member.desc || '';
  document.getElementById('parentInput').value = member.parentId || '';
  document.getElementById('previewImage').src = member.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=random&size=150`;
  // Handle spouse data
  if (member.spouseId) {
    document.getElementById('hasSpouseCheckbox').checked = true;
    document.getElementById('spouseSection').classList.add('active');
    const spouse = familyData.find(p => p.id == member.spouseId);
    if (spouse) {
      document.getElementById('spouseNameInput').value = spouse.name;
      document.getElementById('spouseBirthInput').value = spouse.birth || '';
      document.getElementById('spouseGenderInput').value = spouse.gender || 'unknown';
      document.getElementById('spouseDescInput').value = spouse.desc || '';
      document.getElementById('spousePreviewImage').src = spouse.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(spouse.name)}&background=random&size=150`;
      updateSpousePreview();
    }
  } else {
    document.getElementById('hasSpouseCheckbox').checked = false;
    document.getElementById('spouseSection').classList.remove('active');
  }
  updatePreview();
}
function deleteMember() {
  const selectedId = document.getElementById('memberSelect').value;
  if (!selectedId) {
    showAlert('Ù„Ø·ÙØ§Ù‹ ÙØ±Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'warning');
    return;
  }
  const member = familyData.find(m => m.id == selectedId);
  if (!member) {
    showAlert('ÙØ±Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'danger');
    return;
  }
  if (!confirm(`âš ï¸ Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ "${member.name}" Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ
Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª!`)) {
    return;
  }
  // Also delete spouse if exists
  if (member.spouseId) {
    familyData = familyData.filter(p => p.id !== member.spouseId);
  }
  familyData = familyData.filter(p => p.id != selectedId);
  saveFamilyData();
  refreshAllSelectors();
  renderMembersTable();
  showAlert(`${member.name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯`, 'success');
}
function viewMemberDetails() {
  const selectedId = document.getElementById('memberSelect').value;
  if (!selectedId) {
    showAlert('Ù„Ø·ÙØ§Ù‹ ÙØ±Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'warning');
    return;
  }
  const member = familyData.find(m => m.id == selectedId);
  if (!member) {
    showAlert('ÙØ±Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'danger');
    return;
  }
  let details = `Ù†Ø§Ù…: ${member.name}
`;
  details += `Ø´Ù†Ø§Ø³Ù‡: ${member.id}
`;
  details += `Ø³Ø§Ù„ ØªÙˆÙ„Ø¯: ${member.birth || '---'}
`;
  details += `Ø¬Ù†Ø³ÛŒØª: ${member.gender === 'male' ? 'Ù…Ø±Ø¯' : member.gender === 'female' ? 'Ø²Ù†' : 'Ù†Ø§Ù…Ø´Ø®Øµ'}
`;
  details += `ØªÙˆØ¶ÛŒØ­Ø§Øª: ${member.desc || '---'}
`;
  details += `ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§: ${member.events?.length || 0}
`;
  if (member.parentId) {
    const parent = familyData.find(p => p.id == member.parentId);
    details += `ÙˆØ§Ù„Ø¯: ${parent ? parent.name : '---'}
`;
  }
  if (member.spouseId) {
    const spouse = familyData.find(p => p.id == member.spouseId);
    details += `Ù‡Ù…Ø³Ø±: ${spouse ? spouse.name : '---'}
`;
  }
  alert(`Ø¬Ø²Ø¦ÛŒØ§Øª ${member.name}:
${details}`);
}
// ===============================
// Event Management
// ===============================
function handleEventSubmit(event) {
  event.preventDefault();
  const personId = document.getElementById('eventPersonSelect').value;
  if (!personId) {
    showAlert('Ù„Ø·ÙØ§Ù‹ ÙØ±Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'danger');
    return;
  }
  const eventType = document.getElementById('eventTypeSelect').value;
  const eventYear = document.getElementById('eventYearInput').value.trim();
  const eventDesc = document.getElementById('eventDescInput').value.trim();
  if (!eventDesc) {
    showAlert('ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³Øª', 'danger');
    return;
  }
  const personIndex = familyData.findIndex(p => p.id == personId);
  if (personIndex === -1) {
    showAlert('ÙØ±Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'danger');
    return;
  }
  if (!familyData[personIndex].events) {
    familyData[personIndex].events = [];
  }
  familyData[personIndex].events.push({
    type: eventType,
    year: eventYear,
    description: eventDesc
  });
  saveFamilyData();
  document.getElementById('eventForm').reset();
  showAlert('Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
}
// ===============================
// Event Modal Management
// ===============================
let currentPersonIdForModal = null;
function openEventModal(personId) {
  currentPersonIdForModal = personId;
  const person = familyData.find(p => p.id == personId);
  if (!person) {
    showAlert('ÙØ±Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'danger');
    return;
  }
  document.getElementById('modalTitle').textContent = `Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ ${person.name}`;
  renderEventList();
  document.getElementById('eventModal').style.display = 'flex';
}
function closeEventModal() {
  document.getElementById('eventModal').style.display = 'none';
  currentPersonIdForModal = null;
}
function renderEventList() {
  const container = document.getElementById('eventListContainer');
  const person = familyData.find(p => p.id == currentPersonIdForModal);
  if (!person || !person.events || person.events.length === 0) {
    container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-color); opacity: 0.7;">Ù‡ÛŒÚ† Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ÙØ±Ø¯ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
    return;
  }
  let html = '';
  person.events.forEach((event, index) => {
    html += `
      <div style="background: var(--card-color); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
          <strong style="color: var(--primary-color);">${getEventTypeLabel(event.type)} ${event.year ? '(' + event.year + ')' : ''}</strong>
          <div>
            <button class="btn btn-sm btn-warning" onclick="editEvent(${index})" style="margin-left: 5px;">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteEvent(${index})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div style="color: var(--text-color);">${event.description}</div>
      </div>
    `;
  });
  container.innerHTML = html;
}
function addNewEventInModal() {
  const eventFormHtml = `
    <div id="newEventFormContainer" style="background: var(--card-color); border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
      <h4 style="margin-bottom: 15px; color: var(--primary-color);">Ø§ÙØ²ÙˆØ¯Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯</h4>
      <div class="form-grid">
        <div>
          <div class="form-group">
            <label class="form-label">Ù†ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯ *</label>
            <select id="modalEventTypeSelect" class="form-control" required>
              <option value="birth">ğŸ‘¶ ØªÙˆÙ„Ø¯</option>
              <option value="wedding">ğŸ’ Ø§Ø²Ø¯ÙˆØ§Ø¬</option>
              <option value="death">âš°ï¸ ÙÙˆØª</option>
              <option value="graduation">ğŸ“ ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ÛŒ</option>
              <option value="work">ğŸ’¼ Ø´ØºÙ„</option>
              <option value="travel">âœˆï¸ Ø³ÙØ±</option>
              <option value="other">ğŸ“ Ø³Ø§ÛŒØ±</option>
            </select>
          </div>
        </div>
        <div>
          <div class="form-group">
            <label class="form-label">Ø³Ø§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯</label>
            <input type="text" id="modalEventYearInput" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Û±Û´Û°Û°">
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ *</label>
        <textarea id="modalEventDescInput" class="form-control" placeholder="ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ù…Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯..." rows="3" required></textarea>
      </div>
      <div style="text-align: right; margin-top: 15px;">
        <button class="btn btn-success" onclick="saveNewEvent()">
          <i class="fas fa-plus"></i> Ø°Ø®ÛŒØ±Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯
        </button>
        <button class="btn btn-outline" onclick="cancelNewEvent()" style="margin-right: 10px;">
          <i class="fas fa-times"></i> Ù„ØºÙˆ
        </button>
      </div>
    </div>
  `;
  const container = document.getElementById('eventListContainer');
  container.insertAdjacentHTML('afterbegin', eventFormHtml);
  // Hide the "Add New Event" button
  document.querySelector('button[onclick="addNewEventInModal()"]').style.display = 'none';
}
function cancelNewEvent() {
  const formContainer = document.getElementById('newEventFormContainer');
  if (formContainer) {
    formContainer.remove();
  }
  // Show the "Add New Event" button again
  document.querySelector('button[onclick="addNewEventInModal()"]').style.display = 'inline-flex';
}
function saveNewEvent() {
  const eventType = document.getElementById('modalEventTypeSelect').value;
  const eventYear = document.getElementById('modalEventYearInput').value.trim();
  const eventDesc = document.getElementById('modalEventDescInput').value.trim();
  if (!eventDesc) {
    showAlert('ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³Øª', 'danger');
    return;
  }
  const personIndex = familyData.findIndex(p => p.id == currentPersonIdForModal);
  if (personIndex === -1) {
    showAlert('ÙØ±Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'danger');
    return;
  }
  if (!familyData[personIndex].events) {
    familyData[personIndex].events = [];
  }
  familyData[personIndex].events.push({
    type: eventType,
    year: eventYear,
    description: eventDesc
  });
  saveFamilyData();
  cancelNewEvent(); // Close the form
  renderEventList(); // Refresh the list
  renderMembersTable();
  showAlert('Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
}
function editEvent(index) {
  const person = familyData.find(p => p.id == currentPersonIdForModal);
  const event = person.events[index];
  const editFormHtml = `
    <div id="editEventFormContainer" style="background: var(--card-color); border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
      <h4 style="margin-bottom: 15px; color: var(--primary-color);">ÙˆÛŒØ±Ø§ÛŒØ´ Ø±ÙˆÛŒØ¯Ø§Ø¯</h4>
      <div class="form-grid">
        <div>
          <div class="form-group">
            <label class="form-label">Ù†ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯ *</label>
            <select id="editEventTypeSelect" class="form-control" required>
              <option value="birth" ${event.type === 'birth' ? 'selected' : ''}>ğŸ‘¶ ØªÙˆÙ„Ø¯</option>
              <option value="wedding" ${event.type === 'wedding' ? 'selected' : ''}>ğŸ’ Ø§Ø²Ø¯ÙˆØ§Ø¬</option>
              <option value="death" ${event.type === 'death' ? 'selected' : ''}>âš°ï¸ ÙÙˆØª</option>
              <option value="graduation" ${event.type === 'graduation' ? 'selected' : ''}>ğŸ“ ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ÛŒ</option>
              <option value="work" ${event.type === 'work' ? 'selected' : ''}>ğŸ’¼ Ø´ØºÙ„</option>
              <option value="travel" ${event.type === 'travel' ? 'selected' : ''}>âœˆï¸ Ø³ÙØ±</option>
              <option value="other" ${event.type === 'other' ? 'selected' : ''}>ğŸ“ Ø³Ø§ÛŒØ±</option>
            </select>
          </div>
        </div>
        <div>
          <div class="form-group">
            <label class="form-label">Ø³Ø§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯</label>
            <input type="text" id="editEventYearInput" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Û±Û´Û°Û°" value="${event.year || ''}">
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ *</label>
        <textarea id="editEventDescInput" class="form-control" placeholder="ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ù…Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯..." rows="3" required>${event.description}</textarea>
      </div>
      <div style="text-align: right; margin-top: 15px;">
        <button class="btn btn-success" onclick="saveEditedEvent(${index})">
          <i class="fas fa-save"></i> Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
        </button>
        <button class="btn btn-outline" onclick="cancelEditEvent()" style="margin-right: 10px;">
          <i class="fas fa-times"></i> Ù„ØºÙˆ
        </button>
      </div>
    </div>
  `;
  // Find the event div to replace
  const eventDivs = document.querySelectorAll('#eventListContainer > div');
  if (eventDivs[index]) {
    eventDivs[index].insertAdjacentHTML('beforebegin', editFormHtml);
    eventDivs[index].style.display = 'none'; // Hide the original event div
  }
}
function cancelEditEvent() {
  const formContainer = document.getElementById('editEventFormContainer');
  if (formContainer) {
    formContainer.remove();
  }
  // Show the original event div
  const hiddenDivs = document.querySelectorAll('#eventListContainer > div[style*="display: none"]');
  if (hiddenDivs.length > 0) {
    hiddenDivs[hiddenDivs.length - 1].style.display = 'block';
  }
}
function saveEditedEvent(index) {
  const eventType = document.getElementById('editEventTypeSelect').value;
  const eventYear = document.getElementById('editEventYearInput').value.trim();
  const eventDesc = document.getElementById('editEventDescInput').value.trim();
  if (!eventDesc) {
    showAlert('ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³Øª', 'danger');
    return;
  }
  const personIndex = familyData.findIndex(p => p.id == currentPersonIdForModal);
  if (personIndex === -1) {
    showAlert('ÙØ±Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'danger');
    return;
  }
  familyData[personIndex].events[index] = {
    type: eventType,
    year: eventYear,
    description: eventDesc
  };
  saveFamilyData();
  cancelEditEvent(); // Close the form
  renderEventList(); // Refresh the list
  renderMembersTable();
  showAlert('Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', 'success');
}
function deleteEvent(index) {
  if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) {
    return;
  }
  const personIndex = familyData.findIndex(p => p.id == currentPersonIdForModal);
  if (personIndex === -1) {
    showAlert('ÙØ±Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'danger');
    return;
  }
  familyData[personIndex].events.splice(index, 1);
  saveFamilyData();
  renderEventList();
  renderMembersTable();
  showAlert('Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', 'success');
}
// ===============================
// Stats & Reporting
// ===============================
function updateStats() {
  const total = familyData.length;
  const males = familyData.filter(p => p.gender === 'male').length;
  const females = familyData.filter(p => p.gender === 'female').length;
  const timestamp = localStorage.getItem('familyDataTimestamp');
  const lastUpdate = timestamp ? new Date(parseInt(timestamp)).toLocaleString('fa-IR') : '---';
  document.getElementById('totalMembers').textContent = total;
  document.getElementById('totalMales').textContent = males;
  document.getElementById('totalFemales').textContent = females;
  document.getElementById('lastUpdate').textContent = lastUpdate;
}
function renderMembersTable() {
  const tbody = document.getElementById('membersTableBody');
  tbody.innerHTML = '';
  if (familyData.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">Ù‡ÛŒÚ† Ø¹Ø¶ÙˆÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>`;
    return;
  }
  // Group members by generation
  const generations = {};
  familyData.forEach(person => {
    const gen = calculateGeneration(person.id);
    if (!generations[gen]) {
      generations[gen] = [];
    }
    generations[gen].push(person);
  });
  // Render each generation
  Object.keys(generations).sort((a, b) => a - b).forEach(gen => {
    // Add generation header row
    const genRow = document.createElement('tr');
    genRow.innerHTML = `<td colspan="7" class="generation-header">Ù†Ø³Ù„ ${parseInt(gen) + 1}</td>`;
    tbody.appendChild(genRow);
    // Add members for this generation
    generations[gen].forEach(person => {
      // Skip if this person is already rendered as a spouse
      if (person.spouseId && person.id > person.spouseId) {
        return;
      }
      const parent = person.parentId ? (familyData.find(p => p.id == person.parentId)?.name || '---') : '---';
      const eventsCount = person.events?.length || 0;
      // Create display name (include spouse if exists)
      let displayName = person.name;
      if (person.spouseId) {
        const spouse = familyData.find(p => p.id == person.spouseId);
        if (spouse) {
          displayName += ` & ${spouse.name}`;
        }
      }
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${person.id}</td>
        <td>${displayName}</td>
        <td>${person.birth || '---'}</td>
        <td>${person.gender === 'male' ? 'Ù…Ø±Ø¯' : person.gender === 'female' ? 'Ø²Ù†' : 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
        <td>${parent}</td>
        <td>${eventsCount}</td>
        <td>
          <button class="btn btn-sm btn-info" onclick="openEventModal(${person.id})">
            <i class="fas fa-list"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });
  });
}
function showMemberEvents(personId) {
  const person = familyData.find(p => p.id == personId);
  if (!person) return;
  let eventsText = `Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ ${person.name}:
`;
  if (!person.events || person.events.length === 0) {
    eventsText += "Ù‡ÛŒÚ† Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.";
  } else {
    person.events.forEach((event, index) => {
      eventsText += `${index + 1}. Ù†ÙˆØ¹: ${getEventTypeLabel(event.type)}
`;
      if (event.year) eventsText += `   Ø³Ø§Ù„: ${event.year}
`;
      eventsText += `   ØªÙˆØ¶ÛŒØ­Ø§Øª: ${event.description}
`;
    });
  }
  alert(eventsText);
}
function getEventTypeLabel(type) {
  const types = {
    birth: 'ØªÙˆÙ„Ø¯',
    wedding: 'Ø§Ø²Ø¯ÙˆØ§Ø¬',
    death: 'ÙÙˆØª',
    graduation: 'ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ÛŒ',
    work: 'Ø´ØºÙ„',
    travel: 'Ø³ÙØ±',
    other: 'Ø³Ø§ÛŒØ±'
  };
  return types[type] || type;
}
// ===============================
// Export & Import
// ===============================
function exportToCSV() {
  if (familyData.length === 0) {
    showAlert('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'warning');
    return;
  }
  let csv = 'Ø´Ù†Ø§Ø³Ù‡,Ù†Ø§Ù… Ùˆ Ù‡Ù…Ø³Ø±,Ø³Ø§Ù„ ØªÙˆÙ„Ø¯,Ø¬Ù†Ø³ÛŒØª,ÙˆØ§Ù„Ø¯,ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡';
  familyData.forEach(person => {
    // Skip if this person is already rendered as a spouse
    if (person.spouseId && person.id > person.spouseId) {
      return;
    }
    const parent = person.parentId ? (familyData.find(p => p.id == person.parentId)?.name || '') : '';
    const eventsCount = person.events?.length || 0;
    const gender = person.gender === 'male' ? 'Ù…Ø±Ø¯' : person.gender === 'female' ? 'Ø²Ù†' : 'Ù†Ø§Ù…Ø´Ø®Øµ';
    // Create display name (include spouse if exists)
    let displayName = person.name;
    if (person.spouseId) {
      const spouse = familyData.find(p => p.id == person.spouseId);
      if (spouse) {
        displayName += ` & ${spouse.name}`;
      }
    }
    csv += `"${person.id}","${displayName}","${person.birth || ''}","${gender}","${parent}","${eventsCount}"
`;
  });
  downloadFile(csv, 'family_data.csv', 'text/csv; charset=utf-8');
}
// ========== ØªØ§Ø¨Ø¹ backupData Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ data.json ==========
function backupData() {
  if (familyData.length === 0) {
    showAlert('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'warning');
    return;
  }
  const backup = {
    lastUpdated: new Date().toISOString(),
    familyData: familyData
  };
  downloadFile(JSON.stringify(backup, null, 2), 'data.json', 'application/json');
  showAlert('ÙØ§ÛŒÙ„ data.json Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³Øª!', 'success');
}
function importData() {
  document.getElementById('importFileInput').click();
}
function handleImportFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (!imported.data || !Array.isArray(imported.data)) {
        throw new Error('Invalid backup format');
      }
      if (!confirm(`âš ï¸ Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ø§ ${imported.data.length} Ø¹Ø¶Ùˆ Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ØŸ
Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª!`)) {
        return;
      }
      familyData = imported.data;
      saveFamilyData();
      refreshAllSelectors();
      renderMembersTable();
      showAlert('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯Ù†Ø¯', 'success');
    } catch (error) {
      console.error('Error importing ', error);
      showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ - ÙØ§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª', 'danger');
    }
  };
  reader.readAsText(file);
}
function downloadFile(content, filename, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
// ===============================
// Advanced Features
// ===============================
function validateData() {
  let errors = [];
  familyData.forEach(person => {
    if (person.parentId && !familyData.some(p => p.id == person.parentId)) {
      errors.push(`ÙØ±Ø¯ ${person.name} (ID: ${person.id}) Ø¨Ù‡ ÙˆØ§Ù„Ø¯ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ (ID: ${person.parentId}) Ø§Ø´Ø§Ø±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.`);
    }
    if (person.spouseId && !familyData.some(p => p.id == person.spouseId)) {
      errors.push(`ÙØ±Ø¯ ${person.name} (ID: ${person.id}) Ø¨Ù‡ Ù‡Ù…Ø³Ø± Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ (ID: ${person.spouseId}) Ø§Ø´Ø§Ø±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.`);
    }
    if (person.spouseId === person.id) {
      errors.push(`ÙØ±Ø¯ ${person.name} (ID: ${person.id}) Ø¨Ø§ Ø®ÙˆØ¯Ø´ Ø§Ø²Ø¯ÙˆØ§Ø¬ Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª!`);
    }
    if (person.parentId === person.id) {
      errors.push(`ÙØ±Ø¯ ${person.name} (ID: ${person.id}) ÙˆØ§Ù„Ø¯ Ø®ÙˆØ¯Ø´ Ø§Ø³Øª!`);
    }
  });
  if (errors.length === 0) {
    showAlert('âœ… ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø³Ø§Ù„Ù… Ù‡Ø³ØªÙ†Ø¯!', 'success');
  } else {
    let message = `âš ï¸ ${errors.length} Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÛŒØ§ÙØª Ø´Ø¯:
` + errors.join('');
    alert(message);
    showAlert(`${errors.length} Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÛŒØ§ÙØª Ø´Ø¯`, 'danger');
  }
}
function repairData() {
  let repaired = 0;
  familyData = familyData.map(person => {
    // Fix self-references
    if (person.spouseId === person.id) {
      person.spouseId = null;
      repaired++;
    }
    if (person.parentId === person.id) {
      person.parentId = null;
      repaired++;
    }
    // Remove references to non-existent members
    if (person.parentId && !familyData.some(p => p.id == person.parentId)) {
      person.parentId = null;
      repaired++;
    }
    if (person.spouseId && !familyData.some(p => p.id == person.spouseId)) {
      person.spouseId = null;
      repaired++;
    }
    return person;
  });
  if (repaired > 0) {
    saveFamilyData();
    showAlert(`âœ… ${repaired} Ø®Ø·Ø§ ØªØ¹Ù…ÛŒØ± Ø´Ø¯`, 'success');
  } else {
    showAlert('âœ… Ù‡ÛŒÚ† Ø®Ø·Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¹Ù…ÛŒØ± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'info');
  }
}
function resetAllData() {
  if (confirm("ğŸ§¨ Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª!")) {
    familyData = [];
    saveFamilyData();
    refreshAllSelectors();
    renderMembersTable();
    showAlert('ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯', 'success');
  }
}
function generateReport() {
  if (familyData.length === 0) {
    showAlert('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'warning');
    return;
  }
  let report = `ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ø´Ø¬Ø±Ù‡â€ŒÙ†Ø§Ù…Ù‡
`;
  report += `ØªØ§Ø±ÛŒØ® ØªÙˆÙ„ÛŒØ¯: ${new Date().toLocaleString('fa-IR')}
`;
  report += `ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø§Ø¹Ø¶Ø§: ${familyData.length}
`;
  report += `ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±Ø¯Ø§Ù†: ${familyData.filter(p => p.gender === 'male').length}
`;
  report += `ØªØ¹Ø¯Ø§Ø¯ Ø²Ù†Ø§Ù†: ${familyData.filter(p => p.gender === 'female').length}
`;
  report += `ØªØ¹Ø¯Ø§Ø¯ Ø§ÙØ±Ø§Ø¯ Ø±ÛŒØ´Ù‡: ${familyData.filter(p => !p.parentId).length}
`;
  report += `ØªØ¹Ø¯Ø§Ø¯ Ø²ÙˆØ¬â€ŒÙ‡Ø§: ${familyData.filter(p => p.spouseId && p.id < p.spouseId).length}
`;
  report += `Ù…Ø¬Ù…ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§: ${familyData.reduce((sum, p) => sum + (p.events?.length || 0), 0)}
`;
  report += `ğŸ“‹ Ù„ÛŒØ³Øª Ø§Ø¹Ø¶Ø§:
`;
  // Group by generation for report
  const generations = {};
  familyData.forEach(person => {
    const gen = calculateGeneration(person.id);
    if (!generations[gen]) {
      generations[gen] = [];
    }
    generations[gen].push(person);
  });
  Object.keys(generations).sort((a, b) => a - b).forEach(gen => {
    report += `
=== Ù†Ø³Ù„ ${parseInt(gen) + 1} ===
`;
    generations[gen].forEach(person => {
      // Skip if this person is already rendered as a spouse
      if (person.spouseId && person.id > person.spouseId) {
        return;
      }
      report += `
---
`;
      report += `Ù†Ø§Ù…: ${person.name}
`;
      report += `Ø´Ù†Ø§Ø³Ù‡: ${person.id}
`;
      report += `ØªÙˆÙ„Ø¯: ${person.birth || '---'}
`;
      report += `Ø¬Ù†Ø³ÛŒØª: ${person.gender === 'male' ? 'Ù…Ø±Ø¯' : person.gender === 'female' ? 'Ø²Ù†' : 'Ù†Ø§Ù…Ø´Ø®Øµ'}
`;
      if (person.parentId) {
        const parent = familyData.find(p => p.id == person.parentId);
        report += `ÙˆØ§Ù„Ø¯: ${parent ? parent.name : '---'}
`;
      }
      if (person.spouseId) {
        const spouse = familyData.find(p => p.id == person.spouseId);
        report += `Ù‡Ù…Ø³Ø±: ${spouse ? spouse.name : '---'}
`;
      }
      report += `ØªÙˆØ¶ÛŒØ­Ø§Øª: ${person.desc || '---'}
`;
      if (person.events && person.events.length > 0) {
        report += `Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ (${person.events.length}):
`;
        person.events.forEach(event => {
          report += `  - ${getEventTypeLabel(event.type)} ${event.year ? '(' + event.year + ')' : ''}: ${event.description}
`;
        });
      }
    });
  });
  downloadFile(report, 'family_report.txt', 'text/plain; charset=utf-8');
  showAlert('Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
}
function showStatistics() {
  if (familyData.length === 0) {
    showAlert('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'warning');
    return;
  }
  const birthYears = familyData
    .filter(p => p.birth)
    .map(p => parseInt(p.birth.replace(/[^\d]/g, '')))
    .filter(year => !isNaN(year));
  let stats = `ğŸ“ˆ Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ Ø´Ø¬Ø±Ù‡â€ŒÙ†Ø§Ù…Ù‡
`;
  stats += `Ú©Ù„ Ø§Ø¹Ø¶Ø§: ${familyData.length}
`;
  stats += `Ù…Ø±Ø¯Ø§Ù†: ${familyData.filter(p => p.gender === 'male').length}
`;
  stats += `Ø²Ù†Ø§Ù†: ${familyData.filter(p => p.gender === 'female').length}
`;
  stats += `Ù†Ø§Ù…Ø´Ø®Øµ: ${familyData.filter(p => p.gender === 'unknown').length}
`;
  if (birthYears.length > 0) {
    const minYear = Math.min(...birthYears);
    const maxYear = Math.max(...birthYears);
    const avgYear = Math.round(birthYears.reduce((a, b) => a + b, 0) / birthYears.length);
    stats += `Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† ØªÙˆÙ„Ø¯: ${minYear}
`;
    stats += `Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† ØªÙˆÙ„Ø¯: ${maxYear}
`;
    stats += `Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³Ø§Ù„ ØªÙˆÙ„Ø¯: ${avgYear}
`;
  }
  const eventsByType = {};
  familyData.forEach(p => {
    if (p.events) {
      p.events.forEach(event => {
        eventsByType[event.type] = (eventsByType[event.type] || 0) + 1;
      });
    }
  });
  if (Object.keys(eventsByType).length > 0) {
    stats += `ğŸ“Š ØªÙˆØ²ÛŒØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§:
`;
    Object.entries(eventsByType).forEach(([type, count]) => {
      stats += `  ${getEventTypeLabel(type)}: ${count}
`;
    });
  }
  alert(stats);
}
function exportAdvanced() {
  if (familyData.length === 0) {
    showAlert('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'warning');
    return;
  }
  const exportData = {
    meta :{
      totalMembers: familyData.length,
      totalMales: familyData.filter(p => p.gender === 'male').length,
      totalFemales: familyData.filter(p => p.gender === 'female').length,
      totalEvents: familyData.reduce((sum, p) => sum + (p.events?.length || 0), 0),
      exportDate: new Date().toISOString(),
      version: 'advanced-export-v1'
    },
    members: familyData.map(person => ({
      id: person.id,
      name: person.name,
      birth: person.birth,
      gender: person.gender,
      description: person.desc,
      photoUrl: person.photo,
      parentId: person.parentId,
      spouseId: person.spouseId,
      events: person.events || [],
      generation: calculateGeneration(person.id)
    }))
  };
  downloadFile(JSON.stringify(exportData, null, 2), 'family_advanced_export.json', 'application/json');
  showAlert('Ø®Ø±ÙˆØ¬ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
}
function calculateGeneration(personId, depth = 0) {
  // Simple generation calculation (depth from root)
  const person = familyData.find(p => p.id == personId);
  if (!person || !person.parentId) return depth;
  return calculateGeneration(person.parentId, depth + 1);
}
// ===============================
// Theme & UI
// ===============================
function toggleTheme() {
  currentTheme = currentTheme === 'light' ? 'dark' : 'light';
  document.body.setAttribute('data-theme', currentTheme);
  localStorage.setItem('theme', currentTheme);
  updateThemeIcon();
  showAlert(`ØªÙ… ${currentTheme === 'dark' ? 'ØªØ§Ø±ÛŒÚ©' : 'Ø±ÙˆØ´Ù†'} ÙØ¹Ø§Ù„ Ø´Ø¯`, 'info');
}
function updateThemeIcon() {
  const icon = document.querySelector('.theme-toggle i');
  if (currentTheme === 'dark') {
    icon.className = 'fas fa-sun';
  } else {
    icon.className = 'fas fa-moon';
  }
}
function showAlert(message, type = 'info') {
  // Create alert element
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type}`;
  alertDiv.innerHTML = `
    <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                     type === 'warning' ? 'fa-exclamation-triangle' : 
                     type === 'danger' ? 'fa-times-circle' : 
                     'fa-info-circle'}"></i>
    <span>${message}</span>
  `;
  // Add to body
  document.body.appendChild(alertDiv);
  // Auto remove after 3 seconds
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.style.opacity = '0';
      alertDiv.style.transition = 'opacity 0.3s ease';
      setTimeout(() => {
        if (alertDiv.parentNode) {
          document.body.removeChild(alertDiv);
        }
      }, 300);
    }
  }, 3000);
}
// Initialize
loadFamilyData();
updateStats();
renderMembersTable();
</script>
</body>
</html>